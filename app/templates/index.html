<!DOCTYPE html>
<html>
<head>
    <title>Rsync Webç•Œé¢</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 5px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input[type="text"], input[type="time"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .delete-btn {
            background-color: #f44336;
        }
        .delete-btn:hover {
            background-color: #da190b;
        }
        #result {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #dff0d8;
            border: 1px solid #d6e9c6;
            color: #3c763d;
        }
        .error {
            background-color: #f2dede;
            border: 1px solid #ebccd1;
            color: #a94442;
        }
        .tasks {
            margin-top: 30px;
        }
        .task {
            background-color: white;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .schedule-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .schedule-options {
            display: none;
        }
        .schedule-options.active {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        select, input[type="time"], input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            height: 36px;
            box-sizing: border-box;
            font-size: 14px;
        }
        #schedule_type {
            min-width: 100px;
        }
        #week_day {
            min-width: 90px;
        }
        input[type="number"] {
            width: 80px;
        }
        input[type="time"] {
            width: 110px;
            padding: 4px 8px;
        }
        .sync-btn {
            background-color: #2196F3;
        }
        .sync-btn:hover {
            background-color: #1976D2;
        }
        select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 8L2 4h8z'/%3E%3C/svg%3E") no-repeat right 8px center;
            padding-right: 24px;
        }
        .path-selector {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 400px;
            max-width: 600px;
            display: none;
        }
        
        .path-selector .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .path-selector .current-path {
            background: #f5f5f5;
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 4px;
            word-break: break-all;
        }
        
        .path-selector .items {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .path-selector .item {
            padding: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .path-selector .item:hover {
            background: #f5f5f5;
        }
        
        .path-selector .item i {
            font-size: 1.2em;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        
        .path-selector .item.selected {
            background-color: #e3f2fd;
        }
        
        .path-selector .header button {
            background-color: #4CAF50;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .path-selector .header button:hover {
            background-color: #45a049;
        }
        
        .path-selector .header button:last-child {
            background-color: #f44336;
        }
        
        .path-selector .header button:last-child:hover {
            background-color: #da190b;
        }

        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 10px;
            }

            .form-group {
                margin-bottom: 10px;
            }

            .form-group > div {
                flex-direction: column;
                gap: 5px;
            }

            .form-group > div button {
                width: 100%;
                margin-top: 5px;
            }

            .schedule-group {
                flex-direction: column;
                align-items: stretch;
            }

            .schedule-options {
                flex-direction: column;
                width: 100%;
            }

            .schedule-options.active {
                flex-direction: column;
            }

            select, input[type="time"], input[type="number"] {
                width: 100%;
                margin: 5px 0;
            }

            .path-selector {
                width: 90%;
                min-width: auto;
                max-width: none;
            }

            .task {
                padding: 15px;
            }

            .task button {
                width: 100%;
                margin-top: 5px;
            }

            button {
                width: 100%;
                margin: 5px 0;
            }
        }

        @media screen and (min-width: 769px) and (max-width: 1024px) {
            body {
                max-width: 90%;
            }

            .container {
                padding: 15px;
            }
        }

        @media screen and (min-width: 1025px) {
            .container {
                max-width: 1000px;
                margin: 0 auto;
            }
        }

        .edit-btn {
            background-color: #FF9800;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
        }
        
        .edit-btn:hover {
            background-color: #F57C00;
        }
        
        .task-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .edit-schedule {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .checkbox-label input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .sync-options {
            background-color: #fff;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            min-height: 60px;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Rsync Webç•Œé¢</h1>
        <div class="form-group">
            <label for="source">æºè·¯å¾„:</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="source" placeholder="/home/path/">
                <button onclick="openPathSelector('source')">é€‰æ‹©</button>
            </div>
        </div>
        <div class="form-group">
            <label for="destination">ç›®æ ‡è·¯å¾„:</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="destination" placeholder="/data/path/">
                <button onclick="openPathSelector('destination')">é€‰æ‹©</button>
            </div>
        </div>
        <div class="form-group">
            <label>å®šæ—¶è®¾ç½® (å¯é€‰):</label>
            <div class="schedule-container">
                <div class="schedule-group">
                    <select id="schedule_type" onchange="toggleScheduleOptions()">
                        <option value="none">ä¸è®¾ç½®å®šæ—¶</option>
                        <option value="interval">é—´éš”æ‰§è¡Œ</option>
                        <option value="daily">æ¯å¤©</option>
                        <option value="weekly">æ¯å‘¨</option>
                        <option value="monthly">æ¯æœˆ</option>
                    </select>
                    
                    <div id="daily_options" class="schedule-options">
                        <input type="time" id="daily_time">
                    </div>
                    
                    <div id="weekly_options" class="schedule-options">
                        <select id="week_day">
                            <option value="0">æ˜ŸæœŸæ—¥</option>
                            <option value="1">æ˜ŸæœŸä¸€</option>
                            <option value="2">æ˜ŸæœŸäºŒ</option>
                            <option value="3">æ˜ŸæœŸä¸‰</option>
                            <option value="4">æ˜ŸæœŸå››</option>
                            <option value="5">æ˜ŸæœŸäº”</option>
                            <option value="6">æ˜ŸæœŸå…­</option>
                        </select>
                        <input type="time" id="weekly_time">
                    </div>
                    
                    <div id="monthly_options" class="schedule-options">
                        <input type="number" id="month_day" min="1" max="31" placeholder="æ—¥æœŸ">
                        <input type="time" id="monthly_time">
                    </div>
                    
                    <div id="interval_options" class="schedule-options">
                        <div style="margin-bottom: 5px; color: #666; font-size: 0.9em;">å»ºè®®é—´éš”æ—¶é—´ä¸å°‘äº5åˆ†é’Ÿ</div>
                        <input type="number" id="interval_value" min="1" placeholder="é—´éš”æ•°å€¼">
                        <select id="interval_unit">
                            <option value="minutes">åˆ†é’Ÿ</option>
                            <option value="hours">å°æ—¶</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label>åŒæ­¥é€‰é¡¹:</label>
            <div class="sync-options">
                <label class="checkbox-label">
                    <input type="checkbox" id="delete_option">
                    å¯ç”¨--deleteé€‰é¡¹ï¼ˆåˆ é™¤ç›®æ ‡ç›®å½•ä¸­æºç›®å½•æ²¡æœ‰çš„æ–‡ä»¶ï¼‰
                </label>
            </div>
        </div>
        <div class="form-group">
            <label for="remark">å¤‡æ³¨:</label>
            <textarea id="remark" placeholder="å¯ä»¥æ·»åŠ ä¸€äº›å¤‡æ³¨è¯´æ˜..." rows="3"></textarea>
        </div>
        <button onclick="addTask()">æ·»åŠ </button>
        <div id="result"></div>

        <div class="tasks">
            <h2>åŒæ­¥ä»»åŠ¡åˆ—è¡¨</h2>
            <div id="taskList"></div>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="path-selector" id="pathSelector">
        <div class="header">
            <h3>é€‰æ‹©è·¯å¾„</h3>
            <div>
                <button onclick="confirmPath()" style="margin-right: 10px;">ç¡®å®š</button>
                <button onclick="closePathSelector()">å…³é—­</button>
            </div>
        </div>
        <div class="current-path" id="currentPath"></div>
        <div class="items" id="pathItems"></div>
    </div>

    <script>
        function toggleScheduleOptions() {
            const scheduleType = document.getElementById('schedule_type').value;
            document.querySelectorAll('.schedule-options').forEach(el => el.classList.remove('active'));
            if (scheduleType !== 'none') {
                document.getElementById(`${scheduleType}_options`).classList.add('active');
            }
        }

        function getScheduleInfo() {
            const type = document.getElementById('schedule_type').value;
            if (type === 'none') return null;

            const schedule = { type };
            if (type === 'daily') {
                schedule.time = document.getElementById('daily_time').value;
            } else if (type === 'weekly') {
                schedule.day = document.getElementById('week_day').value;
                schedule.time = document.getElementById('weekly_time').value;
            } else if (type === 'monthly') {
                schedule.day = document.getElementById('month_day').value;
                schedule.time = document.getElementById('monthly_time').value;
            } else if (type === 'interval') {
                schedule.interval = document.getElementById('interval_value').value;
                schedule.unit = document.getElementById('interval_unit').value;
            }
            return schedule;
        }

        function addTask() {
            const source = document.getElementById('source').value;
            const destination = document.getElementById('destination').value;
            const schedule = getScheduleInfo();
            const deleteOption = document.getElementById('delete_option').checked;
            const remark = document.getElementById('remark').value;

            if (!source || !destination) {
                alert('è¯·å¡«å†™æºè·¯å¾„å’Œç›®æ ‡è·¯å¾„');
                return;
            }

            const formData = new FormData();
            formData.append('source', source);
            formData.append('destination', destination);
            formData.append('delete_option', deleteOption);
            formData.append('remark', remark);
            if (schedule) {
                formData.append('schedule', JSON.stringify(schedule));
            }

            fetch('/tasks', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadTasks();
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('source').value = '';
                    document.getElementById('destination').value = '';
                    document.getElementById('schedule_type').value = 'none';
                    document.getElementById('delete_option').checked = false;
                    document.getElementById('remark').value = '';
                    toggleScheduleOptions();
                } else {
                    alert('æ·»åŠ ä»»åŠ¡å¤±è´¥: ' + data.error);
                }
            });
        }

        function executeSync(taskId) {
            fetch(`/tasks/${taskId}/sync`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('åŒæ­¥æˆåŠŸ');
                } else {
                    alert('åŒæ­¥å¤±è´¥: ' + data.error);
                }
            });
        }

        function loadTasks() {
            fetch('/tasks')
            .then(response => response.json())
            .then(tasks => {
                const taskList = document.getElementById('taskList');
                taskList.innerHTML = tasks.map(task => {
                    let scheduleText = 'æ— å®šæ—¶';
                    if (task.schedule) {
                        const s = task.schedule;
                        if (s.type === 'daily') {
                            scheduleText = `æ¯å¤© ${s.time}`;
                        } else if (s.type === 'weekly') {
                            const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                            scheduleText = `æ¯å‘¨${days[s.day]} ${s.time}`;
                        } else if (s.type === 'monthly') {
                            scheduleText = `æ¯æœˆ${s.day}æ—¥ ${s.time}`;
                        } else if (s.type === 'interval') {
                            const unit = s.unit === 'minutes' ? 'åˆ†é’Ÿ' : 'å°æ—¶';
                            scheduleText = `æ¯${s.interval}${unit}`;
                        }
                    }

                    const scheduleData = task.schedule ? JSON.stringify(task.schedule).replace(/"/g, '&quot;') : 'null';
                    
                    return `
                        <div class="task">
                            <p>æºè·¯å¾„: ${task.source}</p>
                            <p>ç›®æ ‡è·¯å¾„: ${task.destination}</p>
                            <p>å®šæ—¶: ${scheduleText}</p>
                            <p>åˆ›å»ºæ—¶é—´: ${task.created_at}</p>
                            <p>åŒæ­¥é€‰é¡¹: ${task.delete_option ? 'å¯ç”¨' : 'ç¦ç”¨'}--deleteé€‰é¡¹</p>
                            ${task.remark ? `<p>å¤‡æ³¨: ${task.remark}</p>` : ''}
                            <div class="task-buttons">
                                <button class="sync-btn" onclick="executeSync(${task.id})">ç«‹å³åŒæ­¥</button>
                                <button class="edit-btn" onclick="showEditSchedule(${task.id}, '${scheduleData}')">ç¼–è¾‘å®šæ—¶</button>
                                <button class="delete-btn" onclick="deleteTask(${task.id})">åˆ é™¤</button>
                            </div>
                            <div id="edit-schedule-${task.id}" class="edit-schedule" style="display: none; margin-top: 10px;">
                                <div class="schedule-group">
                                    <select id="edit_schedule_type_${task.id}" onchange="toggleEditScheduleOptions(${task.id})">
                                        <option value="none">ä¸è®¾ç½®å®šæ—¶</option>
                                        <option value="interval">é—´éš”æ‰§è¡Œ</option>
                                        <option value="daily">æ¯å¤©</option>
                                        <option value="weekly">æ¯å‘¨</option>
                                        <option value="monthly">æ¯æœˆ</option>
                                    </select>
                                    
                                    <div id="edit_interval_options_${task.id}" class="schedule-options">
                                        <div style="margin-bottom: 5px; color: #666; font-size: 0.9em;">å»ºè®®é—´éš”æ—¶é—´ä¸å°‘äº5åˆ†é’Ÿ</div>
                                        <input type="number" id="edit_interval_value_${task.id}" min="1" placeholder="é—´éš”æ•°å€¼">
                                        <select id="edit_interval_unit_${task.id}">
                                            <option value="minutes">åˆ†é’Ÿ</option>
                                            <option value="hours">å°æ—¶</option>
                                        </select>
                                    </div>
                                    
                                    <div id="edit_daily_options_${task.id}" class="schedule-options">
                                        <input type="time" id="edit_daily_time_${task.id}">
                                    </div>
                                    
                                    <div id="edit_weekly_options_${task.id}" class="schedule-options">
                                        <select id="edit_week_day_${task.id}">
                                            <option value="0">æ˜ŸæœŸæ—¥</option>
                                            <option value="1">æ˜ŸæœŸä¸€</option>
                                            <option value="2">æ˜ŸæœŸäºŒ</option>
                                            <option value="3">æ˜ŸæœŸä¸‰</option>
                                            <option value="4">æ˜ŸæœŸå››</option>
                                            <option value="5">æ˜ŸæœŸäº”</option>
                                            <option value="6">æ˜ŸæœŸå…­</option>
                                        </select>
                                        <input type="time" id="edit_weekly_time_${task.id}">
                                    </div>
                                    
                                    <div id="edit_monthly_options_${task.id}" class="schedule-options">
                                        <input type="number" id="edit_month_day_${task.id}" min="1" max="31" placeholder="æ—¥æœŸ">
                                        <input type="time" id="edit_monthly_time_${task.id}">
                                    </div>
                                </div>
                                <div style="margin-top: 10px;">
                                    <button onclick="saveSchedule(${task.id})">ç¡®å®š</button>
                                    <button onclick="cancelEditSchedule(${task.id})">å–æ¶ˆ</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }

        function deleteTask(taskId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                fetch(`/tasks/${taskId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadTasks();
                    }
                });
            }
        }

        let currentTarget = null;
        let currentSelectedPath = null;
        
        function openPathSelector(target) {
            currentTarget = target;
            currentSelectedPath = null;
            const input = document.getElementById(target);
            const initialPath = input.value || (target === 'source' ? '/home' : '/data');
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('pathSelector').style.display = 'block';
            loadPath(initialPath);
        }
        
        function selectPath(path, type) {
            if (type === 'directory') {
                loadPath(path);
                currentSelectedPath = path;
            } else {
                currentSelectedPath = path;
            }
        }
        
        function confirmPath() {
            if (currentSelectedPath) {
                document.getElementById(currentTarget).value = currentSelectedPath;
            }
            closePathSelector();
        }
        
        function closePathSelector() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('pathSelector').style.display = 'none';
            currentTarget = null;
            currentSelectedPath = null;
        }
        
        function loadPath(path) {
            fetch(`/list_dir?path=${encodeURIComponent(path)}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('currentPath').textContent = data.current_path;
                    const itemsContainer = document.getElementById('pathItems');
                    itemsContainer.innerHTML = data.items.map(item => `
                        <div class="item" onclick="selectPath('${item.path}', '${item.type}')">
                            <i class="material-icons">${item.type === 'directory' ? 'ğŸ“' : 'ğŸ“„'}</i>
                            ${item.name}
                        </div>
                    `).join('');
                });
        }

        // æ˜¾ç¤ºç¼–è¾‘å®šæ—¶è¡¨å•
        function showEditSchedule(taskId, scheduleStr) {
            const editScheduleDiv = document.getElementById(`edit-schedule-${taskId}`);
            if (!editScheduleDiv) return;
            
            editScheduleDiv.style.display = 'block';
            const typeSelect = document.getElementById(`edit_schedule_type_${taskId}`);
            if (!typeSelect) return;
            
            let schedule = null;
            try {
                schedule = JSON.parse(scheduleStr.replace(/&quot;/g, '"'));
            } catch (e) {
                console.error('Parse schedule error:', e);
            }
            
            if (schedule) {
                typeSelect.value = schedule.type;
                if (schedule.type === 'daily') {
                    document.getElementById(`edit_daily_time_${taskId}`).value = schedule.time;
                } else if (schedule.type === 'weekly') {
                    document.getElementById(`edit_week_day_${taskId}`).value = schedule.day;
                    document.getElementById(`edit_weekly_time_${taskId}`).value = schedule.time;
                } else if (schedule.type === 'monthly') {
                    document.getElementById(`edit_month_day_${taskId}`).value = schedule.day;
                    document.getElementById(`edit_monthly_time_${taskId}`).value = schedule.time;
                } else if (schedule.type === 'interval') {
                    document.getElementById(`edit_interval_value_${taskId}`).value = schedule.interval;
                    document.getElementById(`edit_interval_unit_${taskId}`).value = schedule.unit;
                }
            } else {
                typeSelect.value = 'none';
            }
            
            toggleEditScheduleOptions(taskId);
        }

        // åˆ‡æ¢ç¼–è¾‘å®šæ—¶é€‰é¡¹
        function toggleEditScheduleOptions(taskId) {
            const scheduleType = document.getElementById(`edit_schedule_type_${taskId}`).value;
            document.querySelectorAll(`#edit-schedule-${taskId} .schedule-options`).forEach(el => el.classList.remove('active'));
            if (scheduleType !== 'none') {
                document.getElementById(`edit_${scheduleType}_options_${taskId}`).classList.add('active');
            }
        }

        // è·å–ç¼–è¾‘åçš„å®šæ—¶ä¿¡æ¯
        function getEditScheduleInfo(taskId) {
            const type = document.getElementById(`edit_schedule_type_${taskId}`).value;
            if (type === 'none') return null;

            const schedule = { type };
            if (type === 'daily') {
                schedule.time = document.getElementById(`edit_daily_time_${taskId}`).value;
            } else if (type === 'weekly') {
                schedule.day = document.getElementById(`edit_week_day_${taskId}`).value;
                schedule.time = document.getElementById(`edit_weekly_time_${taskId}`).value;
            } else if (type === 'monthly') {
                schedule.day = document.getElementById(`edit_month_day_${taskId}`).value;
                schedule.time = document.getElementById(`edit_monthly_time_${taskId}`).value;
            } else if (type === 'interval') {
                schedule.interval = document.getElementById(`edit_interval_value_${taskId}`).value;
                schedule.unit = document.getElementById(`edit_interval_unit_${taskId}`).value;
            }
            return schedule;
        }

        // ä¿å­˜å®šæ—¶è®¾ç½®
        function saveSchedule(taskId) {
            const schedule = getEditScheduleInfo(taskId);
            // è¿™é‡Œéœ€è¦åç«¯é…åˆæ·»åŠ æ›´æ–°å®šæ—¶çš„API
            fetch(`/tasks/${taskId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ schedule })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadTasks();
                } else {
                    alert('æ›´æ–°å®šæ—¶è®¾ç½®å¤±ï¿½ï¿½: ' + data.error);
                }
            });
            
            document.getElementById(`edit-schedule-${taskId}`).style.display = 'none';
        }

        // å–æ¶ˆç¼–è¾‘å®šæ—¶
        function cancelEditSchedule(taskId) {
            document.getElementById(`edit-schedule-${taskId}`).style.display = 'none';
        }

        // é¡µé¢åŠ è½½æ—¶åŠ è½½ä»»åŠ¡åˆ—è¡¨
        loadTasks();
    </script>
</body>
</html> 